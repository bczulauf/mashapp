<html>
<head>
  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="/lib/underscore.js"></script>
  <script src="lib/knockout.js"></script>
  <script src="scripts/mash.js"></script>
  <script type="text/javascript" src="lib/moment.js"></script>
  <link rel="stylesheet" type="text/css" href="/styles/style.css">
  <script type="text/javascript">
  $(function(){
    var friend_ids = [];
    var user = undefined;

    $(document).on('click', '.photo', function(){
      $(this).toggleClass('selected');
    });

    window.fbAsyncInit = function() {
      FB.init({
        appId      : '232433826959882',
        status     : true, // check login status
        cookie     : true, // enable cookies to allow the server to access the session
        xfbml      : true  // parse XFBML
      });

      FB.Event.subscribe('auth.authResponseChange', function(response) {
        if (response.status === 'connected') {
          // should this be here?
          ko.applyBindings(viewModel, document.getElementById('content'));
          getUser(response.authResponse.userID);
        } else if (response.status === 'not_authorized') {
          FB.login(function(response) {});
        } else {
          FB.login(function(response) {});
        }
      });
    };

    // Load the SDK asynchronously
    (function(d){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "http://connect.facebook.net/en_US/all.js";
     ref.parentNode.insertBefore(js, ref);
    }(document));


    function getUser(user_id) {
      // first check to see if user exists
      $.get('/user/' + user_id, function(data){
        
        var userObj = JSON.parse(data);

        if(userObj){

          user = userObj;
          console.log(user);
          accountViewModel = new accountViewModel(user);
          ko.applyBindings(accountViewModel, document.getElementById('account-view'));  
          //viewModel.selectedView({templateName: "accountTemplate", data: accountViewModel});

          getFriendsList();

        } else {
          FB.api('/me?fields=picture.type(small),name, email', function(response) {
            
            console.log(response);

            $.post('/user/add/', 
              { 
                user_id: response.id, 
                name: response.name, 
                email: response.email,
                photo: response.picture.data.url },
              function(data){
                user = JSON.parse(data);
                getFriendsList();
              });

          });
        }
      });
    }

    function getFriendsList(){
      FB.api('/me/friends?fields=name,picture.type(large)', function(result) {
        // picture size: square, small, normal, large

        console.log(result);

        var friend_list = result.data;
        var photo_hash = {};

        _.each(friend_list, function(item){
          photo_hash[item.id] = item.picture.data.url;
        });

        var ids = Object.keys(photo_hash);

        $.get('/users/?id=' + ids.join('&id='), function(data){
          if(data){

            var friends = [];

            for(var i=0; i < data.length; i++){
              var u = JSON.parse(data[i]);
              u.photo = 'url(' + photo_hash[u.user_id] + ')';
              u.status = 'single';
              friends.push(u);
            }

            usersViewModel = new usersViewModel();
            usersViewModel.users = ko.observableArray(friends);
            viewModel.selectedView({templateName: "userTemplate", data: usersViewModel});
          }
        });
      });
    }

  });
</script>
</head>
<body>
  <div id="fb-root"></div>
  <!-- <div id="profile_pics"></div> -->
<div class="container">
    <header id="account-view" data-bind="template: { name: 'accountTemplate'}" class="clearfix"></header>
    <div id="content">
      <fb:login-button data-size="xlarge" show-faces="true" scope="email" max-rows="1"></fb:login-button>
      <div data-bind="with: selectedView">
        <div data-bind="template: { name: templateName, data: data }"></div>
      </div>
    </div>
  </div>
  <script id="accountTemplate" type="text/html">
    <div id="logo">mash</div>
    <div id="account" class="cta lg-cta photo" data-bind="style: {'background-image': photo}">
      <div id="alert" class="cta sm-cta">2</div>
    </div>
    <div id="status">
      <div id="status-text" class="text-single">Single</div>
      <div id="status-button"></div>
    </div>
  </script>
  <script id="userTemplate" type="text/html">
    <div id="user-instruction" class="instruction">Click two friends to propose a date</div>
    <div data-bind="foreach: users">
      <div class="user-profile photo" data-bind="click: $parent.match, css: status, style: {'background-image': photo}">
      </div>
    </div>
  </script>

  <script id="proposalTemplate" type="text/html">
    <div id="proposal-instruction" class="instruction">Propose a date between</div>
    <div data-bind="foreach: participants">
      <div class="user-profile photo" data-bind="style: {'background-image': photo}">
      </div>
    </div>
    <form>
      <textarea id="message-area" data-bind="text: message"></textarea>
      <input type="text" placeholder="Location: JOes Crab Shack" />
      <input type="text" placeholder="Time: " />
      <button id="submit-proposal" type="submit">Submit</button>
    </form>
  </script>
</body>
</html>